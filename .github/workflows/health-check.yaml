name: Health Check

on:
  workflow_dispatch:

  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'

jobs:
  check-queue:
    name: Check Build Queue Health
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build buildctl
        run: go build -o buildctl ./cmd/buildctl

      - name: Download latest database
        run: |
          gh release download --pattern "buildqueue.db" --repo ${{ github.repository }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check queue health
        id: health
        run: |
          if [ ! -f buildqueue.db ]; then
            echo "healthy=unknown" >> $GITHUB_OUTPUT
            echo "No database found"
            exit 0
          fi

          # Get statistics
          ./buildctl stats > stats.txt

          # Extract metrics
          TOTAL=$(grep "Total Builds" stats.txt | awk '{print $3}' || echo "0")
          SUCCESS_RATE=$(grep "Success Rate" stats.txt | awk '{print $3}' || echo "0")
          FAILED=$(./buildctl list --status failed | grep -c "^ID:" || echo "0")
          BUILDING=$(./buildctl list --status building | grep -c "^ID:" || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "building=$BUILDING" >> $GITHUB_OUTPUT

          # Determine health status
          if [ "$FAILED" -gt 100 ]; then
            echo "healthy=unhealthy" >> $GITHUB_OUTPUT
            echo "âš ï¸ High number of failed builds: $FAILED"
          elif [ "$BUILDING" -gt 50 ]; then
            echo "healthy=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ Many builds still in progress: $BUILDING"
          else
            echo "healthy=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Queue is healthy"
          fi

          cat stats.txt

      - name: Create health report
        run: |
          echo "# Build Queue Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.health.outputs.healthy }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Builds:** ${{ steps.health.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "**Success Rate:** ${{ steps.health.outputs.success_rate }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Builds:** ${{ steps.health.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Building:** ${{ steps.health.outputs.building }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f stats.txt ]; then
            echo "## Detailed Statistics" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat stats.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on unhealthy status
        if: steps.health.outputs.healthy == 'unhealthy'
        uses: actions/github-script@v8
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Build Queue Health Check Failed',
              body: `# Build Queue Health Issue

              The automated health check has detected issues with the build queue.

              ## Metrics
              - **Total Builds:** ${{ steps.health.outputs.total }}
              - **Success Rate:** ${{ steps.health.outputs.success_rate }}%
              - **Failed Builds:** ${{ steps.health.outputs.failed }}
              - **Building:** ${{ steps.health.outputs.building }}

              ## Action Required
              Please investigate the failed builds and consider:
              1. Checking error logs: \`buildctl list --status failed\`
              2. Retrying failed builds: \`buildctl reset --failed\`
              3. Manually triggering retry workflow

              ## Links
              - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [Latest Release](https://github.com/${{ github.repository }}/releases/latest)

              ---
              ðŸ¤– Auto-generated by health-check workflow`,
              labels: ['automated', 'health-check', 'needs-attention']
            });

            console.log(`Created issue: ${issue.data.number}`);

  check-ghcr:
    name: Check GHCR Package Availability
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check package availability
        run: |
          # Sample popular packages to check
          PACKAGES=("btop" "neofetch" "htop" "fzf" "ripgrep")

          echo "# GHCR Package Availability" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for pkg in "${PACKAGES[@]}"; do
            if docker manifest inspect "ghcr.io/${{ github.repository_owner }}/$pkg:latest" &> /dev/null; then
              echo "| $pkg | âœ… Available |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $pkg | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  check-releases:
    name: Check Release Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check latest release age
        run: |
          LATEST=$(gh release view --repo ${{ github.repository }} --json publishedAt -q .publishedAt)
          NOW=$(date -u +%s)
          RELEASE_TIME=$(date -d "$LATEST" +%s)
          AGE_HOURS=$(( (NOW - RELEASE_TIME) / 3600 ))

          echo "# Release Freshness" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Release:** $LATEST" >> $GITHUB_STEP_SUMMARY
          echo "**Age:** $AGE_HOURS hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$AGE_HOURS" -gt 12 ]; then
            echo "âš ï¸ Latest release is older than 12 hours" >> $GITHUB_STEP_SUMMARY
            echo "status=stale" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release is fresh" >> $GITHUB_STEP_SUMMARY
            echo "status=fresh" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
