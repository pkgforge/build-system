name: Quick Package Update

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Comma-separated list of packages to build (e.g., btop,neofetch,htop)'
        required: true
        type: string
      arch:
        description: 'Architecture to build'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - x86_64-Linux
          - aarch64-Linux
          - riscv64-Linux
      priority:
        description: 'Build priority (higher = built first)'
        required: false
        default: '50'
        type: string

jobs:
  # Determine which architectures to build
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix based on input
        id: set-matrix
        run: |
          if [ "${{ inputs.arch }}" = "all" ]; then
            echo 'matrix={"include":[{"arch":"x86_64-Linux","runner":"ubuntu-latest"},{"arch":"aarch64-Linux","runner":"ubuntu-24.04-arm64"}]}' >> $GITHUB_OUTPUT
          elif [ "${{ inputs.arch }}" = "x86_64-Linux" ]; then
            echo 'matrix={"include":[{"arch":"x86_64-Linux","runner":"ubuntu-latest"}]}' >> $GITHUB_OUTPUT
          elif [ "${{ inputs.arch }}" = "aarch64-Linux" ]; then
            echo 'matrix={"include":[{"arch":"aarch64-Linux","runner":"ubuntu-24.04-arm64"}]}' >> $GITHUB_OUTPUT
          else
            echo 'matrix={"include":[{"arch":"x86_64-Linux","runner":"ubuntu-latest"}]}' >> $GITHUB_OUTPUT
          fi

  quick-build:
    name: Quick Build - ${{ matrix.arch }}
    needs: setup
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup.outputs.matrix) }}

    steps:
      - name: Checkout build-system
        uses: actions/checkout@v4

      - name: Checkout soarpkgs
        uses: actions/checkout@v4
        with:
          repository: pkgforge/soarpkgs
          path: soarpkgs

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build buildctl
        run: |
          go build -o buildctl ./cmd/buildctl

      - name: Setup build environment
        run: |
          echo "Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y curl wget git build-essential jq coreutils grep findutils tar gzip bzip2 xz-utils zstd file sed gawk

          echo ""
          echo "Installing pkgforge tools..."

          # Install soar (package manager required by sbuild)
          echo "- Installing soar..."
          curl -qfsSL "https://bin.pkgforge.dev/${{ matrix.arch }}/soar" -o /tmp/soar
          sudo install -m 755 /tmp/soar /usr/local/bin/soar
          soar --version || echo "soar installed"

          # Add soar bin directory to PATH
          echo "$HOME/.local/share/soar/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/soar/bin:$PATH"

          # Install b3sum (BLAKE3 checksum tool)
          echo "- Installing b3sum..."
          curl -qfsSL "https://bin.pkgforge.dev/${{ matrix.arch }}/b3sum" -o /tmp/b3sum
          sudo install -m 755 /tmp/b3sum /usr/local/bin/b3sum
          b3sum --version || echo "b3sum installed"

          # Install yj (YAML/JSON converter)
          echo "- Installing yj..."
          curl -qfsSL "https://bin.pkgforge.dev/${{ matrix.arch }}/yj" -o /tmp/yj
          sudo install -m 755 /tmp/yj /usr/local/bin/yj
          yj --version || echo "yj installed"

          # Install yq (YAML processor)
          echo "- Installing yq..."
          curl -qfsSL "https://bin.pkgforge.dev/${{ matrix.arch }}/yq" -o /tmp/yq
          sudo install -m 755 /tmp/yq /usr/local/bin/yq
          yq --version || echo "yq installed"

          # Install squishy-cli (AppImage manipulation tool)
          echo "- Installing squishy-cli..."
          SQUISHY_ARCH="${{ matrix.arch }}"
          SQUISHY_ARCH="${SQUISHY_ARCH//-Linux/}"
          SQUISHY_ARCH="${SQUISHY_ARCH,,}"  # Convert to lowercase
          curl -qfsSL "https://github.com/pkgforge/squishy-rs/releases/download/v0.3.1/squishy-${SQUISHY_ARCH}-linux" -o /tmp/squishy
          sudo install -m 755 /tmp/squishy /usr/local/bin/squishy-cli
          squishy-cli --version || echo "squishy-cli installed"

          # Install appimagetool (AppImage creation tool)
          echo "- Installing appimagetool..."
          APPIMAGETOOL_ARCH="${{ matrix.arch }}"
          APPIMAGETOOL_ARCH="${APPIMAGETOOL_ARCH//-Linux/}"
          curl -qfsSL "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-${APPIMAGETOOL_ARCH}.AppImage" -o /tmp/appimagetool
          sudo install -m 755 /tmp/appimagetool /usr/local/bin/appimagetool
          appimagetool --version || echo "appimagetool installed"

          # Install oras (OCI Registry As Storage - for GHCR uploads)
          echo "- Installing oras..."
          ORAS_VERSION="1.3.0"
          ORAS_ARCH="${{ matrix.arch }}"
          # Convert arch format: x86_64-Linux -> amd64, aarch64-Linux -> arm64
          if [ "$ORAS_ARCH" = "x86_64-Linux" ]; then
            ORAS_ARCH="amd64"
          elif [ "$ORAS_ARCH" = "aarch64-Linux" ]; then
            ORAS_ARCH="arm64"
          else
            ORAS_ARCH="${ORAS_ARCH//-Linux/}"
            ORAS_ARCH="${ORAS_ARCH,,}"
          fi
          curl -qfsSL "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_${ORAS_ARCH}.tar.gz" -o /tmp/oras.tar.gz
          tar -xzf /tmp/oras.tar.gz -C /tmp
          sudo install -m 755 /tmp/oras /usr/local/bin/oras
          oras version || echo "oras installed"

          # Install sbuild (build tool)
          echo "- Installing sbuild..."
          curl -qfsSL "https://github.com/pkgforge/sbuilder/releases/download/v0.1.10-sbuild/sbuild-x86_64-linux" -o /tmp/sbuild
          sudo install -m 755 /tmp/sbuild /usr/local/bin/sbuild
          sbuild --version || sbuild --help

          echo ""
          echo "✓ Build environment ready"

      - name: Login to GHCR (Docker)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GHCR (ORAS)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      - name: Queue and build packages
        run: |
          # Parse comma-separated packages
          IFS=',' read -ra PKGS <<< "${{ inputs.packages }}"

          for pkg in "${PKGS[@]}"; do
            pkg=$(echo "$pkg" | xargs)  # trim whitespace
            echo "Queuing: $pkg for ${{ matrix.arch }}"
            ./buildctl sync --repo "$GITHUB_WORKSPACE/soarpkgs"
            ./buildctl force --repo "$GITHUB_WORKSPACE/soarpkgs" --pkg "$pkg" --arch "${{ matrix.arch }}"
          done

          # Show queue
          ./buildctl status

          # Build queued packages
          echo ""
          echo "=========================================="
          echo "Building Queued Packages"
          echo "=========================================="

          while true; do
            # Get next queued build
            BUILD=$(./buildctl list --status queued --limit 1 2>/dev/null | grep "^ID:" | head -1)

            if [ -z "$BUILD" ]; then
              echo "No more builds in queue"
              break
            fi

            # Extract build ID and package name
            BUILD_ID=$(echo "$BUILD" | awk -F'|' '{print $1}' | awk '{print $2}')
            PKG_NAME=$(echo "$BUILD" | awk -F'|' '{print $3}' | awk '{print $1}')

            echo ""
            echo "Building: $PKG_NAME (ID: $BUILD_ID)"

            # Execute build
            if ./buildctl build --repo "$GITHUB_WORKSPACE/soarpkgs" --id "$BUILD_ID" --arch "${{ matrix.arch }}"; then
              echo "✓ Build succeeded: $PKG_NAME"
            else
              echo "✗ Build failed: $PKG_NAME"
              exit 1
            fi
          done

          echo ""
          echo "=========================================="
          echo "Final Status"
          echo "=========================================="
          ./buildctl status

      - name: Create summary
        if: always()
        run: |
          echo "# Quick Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Packages:** ${{ inputs.packages }}" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ./buildctl status >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
