name: Retry Failed Builds

on:
  workflow_dispatch:
    inputs:
      max_retries:
        description: 'Maximum builds to retry'
        required: false
        default: '50'
        type: string

  schedule:
    # Retry failed builds once daily
    - cron: '0 2 * * *'

jobs:
  retry-failed:
    name: Retry Failed Builds
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout build-system
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build buildctl
        run: go build -o buildctl ./cmd/buildctl

      - name: Download latest database
        run: |
          # Download database from latest release
          gh release download --pattern "buildqueue.db" --repo ${{ github.repository }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List failed builds
        id: failed
        run: |
          if [ ! -f buildqueue.db ]; then
            echo "No database found, skipping"
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          COUNT=$(./buildctl list --status failed | grep -c "^ID:" || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT failed builds"

          ./buildctl list --status failed --limit 10

      - name: Reset failed builds
        if: steps.failed.outputs.count > 0
        run: |
          ./buildctl reset --failed
          echo "Reset ${{ steps.failed.outputs.count }} failed builds"

      - name: Trigger build workflow
        if: steps.failed.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-packages.yaml',
              ref: 'main'
            });

            console.log('Triggered build workflow to retry failed builds');
